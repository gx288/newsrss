name: Cập nhật RSS Ung thư

on:
  schedule:
    - cron: '0 */2 * * *'   # Mỗi 2 tiếng
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'  # <<< Thay từ 3.12 thành 3.11

    - name: Cài dependencies + Xvfb
      run: |
        pip install selenium undetected-chromedriver webdriver-manager
        sudo apt-get update -qq
        sudo apt-get install -y xvfb

    - name: Chạy scraper với Xvfb
      run: |
        xvfb-run -a -s "-screen 0 1920x1080x24 +extension RANDR" python -u SKDS/taorsstheolink/scrape_ungthu_rss.py

    - name: Commit & Push nếu có thay đổi
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        echo "=== DANH SÁCH FILE TRONG THƯ MỤC SKDS ==="
        ls -la SKDS/
        
        echo "=== NỘI DUNG FILE RSS (nếu có) ==="
        if [ -f SKDS/ung_thu_rss.xml ]; then
          echo "File tồn tại, kích thước: $(stat -c%s SKDS/ung_thu_rss.xml) bytes"
          head -n 20 SKDS/ung_thu_rss.xml || echo "File rỗng hoặc lỗi"
        else
          echo "KHÔNG TÌM THẤY FILE RSS!"
        fi
        
        git add SKDS/ung_thu_rss.xml
        
        if git diff --cached --quiet; then
          echo "Không có thay đổi → không commit"
        else
          git commit -m "Cập nhật RSS ung thư $(date +'%Y-%m-%d %H:%M') - $(wc -l < SKDS/ung_thu_rss.xml) dòng"
          git push
          echo "ĐÃ COMMIT VÀ PUSH THÀNH CÔNG!"
        fi
